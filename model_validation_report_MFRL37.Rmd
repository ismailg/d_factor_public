---
title: "model_validation_report"
author: "Ismail Guennouni"
date: "`r Sys.Date()`"
output: html_document
---
## Complete Workflow Example

Here's a script showing the entire workflow, assuming we've already fitted the model:

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(gridExtra)
library(corrplot)

# Source the diagnostic tools
source("diagnostic_tools.R")

# 1. Load fitted results and participant data
fit_result_MFRL_v37 <- read.csv("fit_result_MFRL_v37.csv")
final_dat <- read.csv("data/final_data.csv")

# 2. Choose a representative participant for detailed analysis
# Look for a participant with good model fit (low NLL relative to others)
fit_result_MFRL_v37 <- fit_result_MFRL_v37 %>% arrange(neg_log_lik)
participant_id <- fit_result_MFRL_v37$playerId[1]  # Best-fitting participant
participant_data <- subset(final_dat, playerId == participant_id)

# 3. Get fitted parameters for this participant
fitted_params <- list(
  alpha = fit_result_MFRL_v37$alpha[fit_result_MFRL_v37$playerId == participant_id],
  temp = fit_result_MFRL_v37$temp[fit_result_MFRL_v37$playerId == participant_id],
  envy = fit_result_MFRL_v37$envy[fit_result_MFRL_v37$playerId == participant_id],
  guilt = fit_result_MFRL_v37$guilt[fit_result_MFRL_v37$playerId == participant_id]
)

# Fixed parameters
fixed_params <- list(temp=1.5, envy=1)
for (param in names(fixed_params)) {
  fitted_params[[param]] <- fixed_params[[param]]
}

# 4. Parameter sensitivity analysis
slice_results <- generate_parameter_slices(fitted_params, participant_data)
p1 <- plot_parameter_slices(slice_results)
ggsave("plots/parameter_sensitivity.png", p1, width = 10, height = 8)

# 5. Parameter interaction analysis 
interaction_results <- analyze_parameter_interactions(fitted_params, participant_data)
p2 <- plot_parameter_interactions(interaction_results)
ggsave("plots/parameter_interactions.png", p2, width = 12, height = 10)

# 6. Posterior predictive checks
# Blue bands show the range of model predictions, Red points show actual data
# If red points consistently fall outside blue bands, your model may be misspecified
posterior_checks <- generate_posterior_checks(participant_data, fitted_params)
p3 <- plot_posterior_checks(posterior_checks)
ggsave("plots/posterior_checks.png", p3, width = 10, height = 12)


# 7. Group-level parameter analysis
p4 <- ggplot(fit_result_MFRL_v37, aes(x = alpha)) +
  geom_histogram(bins = 20, fill = "skyblue", color = "black") +
  geom_vline(xintercept = mean(fit_result_MFRL_v37$alpha, na.rm = TRUE), 
             color = "red", linetype = "dashed") +
  labs(title = "Distribution of Learning Rate (alpha)",
       x = "alpha",
       y = "Count") +
  theme_minimal()
ggsave("plots/alpha_distribution.png", p4, width = 8, height = 6)

p5 <- ggplot(fit_result_MFRL_v37, aes(x = guilt)) +
  geom_histogram(bins = 20, fill = "skyblue", color = "black") +
  geom_vline(xintercept = mean(fit_result_MFRL_v37$guilt, na.rm = TRUE), 
             color = "red", linetype = "dashed") +
  labs(title = "Distribution of Learning Rate (alpha)",
       x = "alpha",
       y = "Count") +
  theme_minimal()
ggsave("plots/guilt_distribution.png", p5, width = 8, height = 6)

# 8. Generate comprehensive HTML report
#rmarkdown::render("model_validation_report_MFRL37.Rmd", output_format = "html_document")

# 9. Print summary of findings
cat("\nDiagnostic Analysis Complete\n")
cat("===========================\n")
cat("Parameter sensitivity plots saved to: parameter_sensitivity.png\n")
cat("Parameter interaction plots saved to: parameter_interactions.png\n")
cat("Posterior predictive checks saved to: posterior_checks.png\n")
cat("Parameter distributions saved to: alpha_distribution.png, etc.\n")
cat("Comprehensive report saved to: model_validation_report.html\n")

```