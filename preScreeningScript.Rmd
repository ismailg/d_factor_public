---
title: "pre_screening_script"
author: "Ismail Guennouni"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)

library(scales)
library(dplyr)
library(readr)
```


# Preprocessing raw prescreenign file
```{r}


# Read the CSV data
# Read the CSV data with readr, which is more flexible with problematic files
df <- read_csv("data/pre-screening/D-Factor_October 29, 2024_11.41.csv") %>%
  # Skip rows 2 and 3 by filtering them out
  slice(-(2:3))


# Clean and select relevant data
clean_df <- df %>%
  # Select only completed responses (excluding previews)
  filter(`DistributionChannel` == "anonymous") %>%
  # Select columns
  dplyr::select(
    Prolific_ID = PROLIFIC_PID,
    timeStamp = EndDate,
    Q1 = `Questionnaire D _1`,
    Q2 = `Questionnaire D _2`,
    Q3 = `Questionnaire D _3`,
    Q4 = `Questionnaire D _4`,
    Q5 = `Questionnaire D _5`,
    Q6 = `Questionnaire D _6`,
    Q7 = `Questionnaire D _7`,
    Q8 = `Questionnaire D _8`,
    Q9 = `Questionnaire D _9`,
    Q10 = `Questionnaire D _10`,
    Q11 = `Questionnaire D _11`,
    Q12 = `Questionnaire D _12`,
    Q13 = `Questionnaire D _13`,
    Q14 = `Questionnaire D _14`,
    attention_Q15 = `Questionnaire D _15`,
    Q16 = `Questionnaire D _16`,
    Q17 = `Questionnaire D _17`
  ) %>%
  # Remove any empty rows
  filter(!is.na(Prolific_ID))




# First, check attention check (Q15) and filter
scored_df <- clean_df %>%
  filter(attention_Q15 == "Neutral") %>%
  mutate(
    across(starts_with("Q"), ~ case_when(
      . == "Strongly Disagree" ~ 1,
      . == "Disagree" ~ 2,
      . == "Neutral" ~ 3,
      . == "Agree" ~ 4,
      . == "Strongly Agree" ~ 5
    ))
  ) %>%
  # Reverse score items 1, 2, 5, 8, 9, 10, 13, and 17
  mutate(
    Q1 = 6 - Q1,
    Q2 = 6 - Q2,
    Q5 = 6 - Q5,
    Q8 = 6 - Q8,
    Q9 = 6 - Q9,
    Q10 = 6 - Q10,
    Q13 = 6 - Q13,
    Q17 = 6 - Q17
  ) %>%
  # Calculate total score (excluding Q15)
  mutate(
    total_score = rowSums(across(c(Q1:Q14, Q16:Q17))),
    callous_score = rowSums(across(c(Q1,Q4,Q7,Q9,Q17))),
    deceit_score= rowSums(across(c(Q2))),
    sadism_score = rowSums(across(c(Q5,Q8,Q10,Q11,Q13))),
    vindict_score = rowSums(across(c(Q3,Q6,Q12,Q14,Q16)))
  )



# Print summary statistics
print("Number of participants who passed attention check:")
print(nrow(scored_df))

print("Summary of total scores:")
summary(scored_df$total_score)

# View first few rows of scored data
print(head(scored_df))

# Optional: save scored data
write_csv(scored_df, "data/pre-screening/scored_data.csv")
```


# Plotting distribution of scores 

```{r}
# Load required libraries
library(dplyr)
library(readr)
library(ggplot2)

# Create the plot
p <- ggplot(scored_df, aes(x = total_score)) +
  # Add histogram
  geom_histogram(aes(y = after_stat(density)), 
                binwidth = 2, 
                fill = "lightblue", 
                color = "black", 
                alpha = 0.7) +
  # Add density curve
  geom_density(color = "darkred", size = 1) +
  # Add mean line
  geom_vline(aes(xintercept = mean(total_score)), 
             color = "darkred", 
             linetype = "dashed", 
             size = 1) +
  # Customize theme and labels
  theme_minimal() +
  labs(
    title = "Distribution of D-Factor Scores",
    subtitle = sprintf("Mean = %.2f, SD = %.2f, N = %d", 
                      mean(scored_df$total_score), 
                      sd(scored_df$total_score), 
                      nrow(scored_df)),
    x = "D-Factor Score",
    y = "Density"
  ) +
  # Basic theme customization
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    panel.grid.minor = element_blank()
  ) +
  # Set x-axis breaks
  scale_x_continuous(breaks = seq(15, 65, by = 5))

# Print the plot
print(p)

# Save the plot if needed
ggsave("D-factor_distribution.png", p, width = 10, height = 7, dpi = 300)
```

```{r}
# Calculate score percentiles
all_percentiles <- quantile(scored_df$total_score, probs = c(0.1, 0.25, 0.5, 0.75, 0.9))
print("\nAll key percentiles (10th, 25th, 50th, 75th, 90th):")
print(all_percentiles)

# Let's also modify our plot to show these percentiles
p + 
  geom_vline(xintercept = all_percentiles["75%"], 
             color = "blue", 
             linetype = "dashed", 
             size = 0.5) +
  geom_vline(xintercept = all_percentiles["90%"], 
             color = "darkgreen", 
             linetype = "dashed", 
             size = 0.5) +
  annotate("text", 
           x = all_percentiles["75%"] + 1, 
           y = 0.06, 
           label = "75th", 
           angle = 90,
           color = "blue") +
  annotate("text", 
           x = all_percentiles["90%"] + 1, 
           y = 0.06, 
           label = "90th", 
           angle = 90,
           color = "darkgreen")
```


# Correaltions between scores 
```{r}
# Function to create correlation matrix with significance levels
library(Hmisc)
library(corrplot)

# Select variables and remove missing values
vars <- c("total_score", "callous_score", "deceit_score", "sadism_score", "vindict_score")
data <- na.omit(scored_df[vars])

# Calculate correlation matrix with p-values
res <- rcorr(as.matrix(data))


# Function to format correlation and p-value
format_cor <- function(cor, p) {
    stars <- ""
    if (p < 0.001) stars <- "***"
    else if (p < 0.01) stars <- "**"
    else if (p < 0.05) stars <- "*"
    return(paste0(round(cor, 3), stars))
}

# Create and print formatted results
cat("Correlations with significance levels:\n")
cat("Significance codes: *** p<0.001, ** p<0.01, * p<0.05\n\n")

for(i in 1:(length(vars)-1)) {
    for(j in (i+1):length(vars)) {
        cat(sprintf("%s & %s: r = %s (p = %.3f)\n",
                   vars[i], 
                   vars[j],
                   format_cor(res$r[i,j], res$P[i,j]),
                   res$P[i,j]))
    }
}

# Print correlation matrix
cat("\nCorrelation matrix:\n")
print(round(res$r, 3))

# Print p-value matrix
cat("\nP-value matrix:\n")
print(round(res$P, 3))
```


```{r}
# Load psych package
library(psych)

# Select variables and create plot
vars <- c("total_score", "callous_score", "deceit_score", "sadism_score", "vindict_score")
pairs.panels(scored_df[vars], 
            method = "pearson", # correlation method
            hist.col = "#75AADB", # histogram color
            density = TRUE,  # show density plots
            ellipses = TRUE) # show correlation ellipses
```



```{r}
# Get the 10th and 90th percentile values
percentile_10 <- quantile(scored_df$total_score, probs = 0.10)
percentile_90 <- quantile(scored_df$total_score, probs = 0.90)

# Get IDs for participants below/at 10th percentile
bottom_10_ids <- scored_df %>%
 filter(total_score <= 21) %>%
 pull(Prolific_ID)

# Get IDs for participants above/at 90th percentile
top_10_ids <- scored_df %>%
 filter(total_score >= 42) %>%
 pull(Prolific_ID)

# Print results
cat("Prolific IDs for bottom 10% (scores <=", 21, "):\n")
cat(paste(bottom_10_ids, collapse = ", "))

cat("\n\nProlific IDs for top 10% (scores >=", 42, "):\n")
cat(paste(top_10_ids, collapse = ", "))
```

```{r}
length(top_10_ids) + length(bottom_10_ids)
```

```{r}
# Only data collected today 
# Alternatively, without creating new date column:
todays_data <- scored_df %>%
  filter(as_date(timeStamp) == "2024-10-29")

# Get IDs for participants below/at 10th percentile
bottom_10_ids_today <- todays_data %>%
 filter(total_score <= 22) %>%
 pull(Prolific_ID)

# Get IDs for participants above/at 90th percentile
top_10_ids_today <-todays_data %>%
 filter(total_score >= 42) %>%
 pull(Prolific_ID)

# Print results
cat("Prolific IDs for bottom 10% (scores <=", 21, "):\n")
cat(paste(bottom_10_ids_today, collapse = ", "))

cat("\n\nProlific IDs for top 10% (scores >=", 42, "):\n")
cat(paste(top_10_ids_today, collapse = ", "))
```
```{r}
# Add people from before with scores of 22 as we don't have enough low_D people
past_data <- scored_df %>%
  filter(as_date(timeStamp) != "2024-10-29")

# Get IDs for participants below/at 10th percentile
score22 <- past_data %>%
 filter(total_score == 22) %>%
 pull(Prolific_ID)

cat("Prolific IDs with score equal to 22 :\n")
cat(paste(score22 , collapse = ", "))
```




